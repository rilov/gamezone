<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Realistic Car Builder — Wheels Spin Correctly</title>
<style>
  :root { --bg:#0e1116; --panel:#151a21; --accent:#22d3ee; --grid:#222a33; --grid-size:28; }
  *{box-sizing:border-box}
  body{margin:0;color:#e8eef6;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;display:grid;grid-template-columns:320px 1fr;height:100vh}
  aside{background:var(--panel);border-right:1px solid #000;padding:14px;overflow:auto}
  h1{font-size:18px;margin:0 0 8px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:8px}
  .btn{border:1px solid #2a3340;background:#1c2430;color:#e8eef6;padding:8px 10px;border-radius:10px;cursor:pointer}
  .btn:hover{background:#222c3a}
  .icon-btn{display:inline-grid;place-items:center;width:44px;height:44px;padding:0}
  .btn svg{width:22px;height:22px;display:block;fill:currentColor}
  .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  input[type="color"]{width:36px;height:36px;border:none;padding:0;background:transparent}
  select.btn{padding-right:24px}
  .legend{font-size:12px;color:#a9b3bf;line-height:1.5;margin-top:6px}
  .tabs{display:flex;gap:8px;margin:8px 0 12px}
  .tab-btn{border:1px solid #2a3340;background:#131a24;color:#cbd5e1;padding:8px 10px;border-radius:10px;cursor:pointer}
  .tab-btn.active{background:#1f2a3a;color:#e8eef6;outline:2px solid #1f2a3a}
  .tab-panel[hidden]{display:none}
  .saved-panel{position:absolute; inset:auto 12px 12px 12px; background:#0f141b; border:1px solid #2a3340; border-radius:12px; padding:10px; box-shadow:0 10px 30px rgba(0,0,0,.5); display:none; z-index:20}
  .saved-panel h2{margin:0 0 8px; font-size:14px}
  .saved-list{max-height:220px; overflow:auto; display:grid; gap:6px}
  .saved-item{display:flex; justify-content:space-between; align-items:center; background:#121923; border:1px solid #233042; border-radius:8px; padding:6px 8px}
  .saved-item .name{font-size:13px}
  .btn.small{padding:4px 8px; font-size:12px; border-radius:8px}
  .demo-disabled{opacity:.6; pointer-events:none; filter:grayscale(20%)}
  .demo-cursor{position:absolute; width:18px; height:18px; border:2px solid #fff; border-radius:50%; box-shadow:0 0 0 2px rgba(0,0,0,.4); transform:translate(-50%,-50%); z-index:25; display:none}
  main{position:relative;overflow:hidden}
  .stage-wrap{width:100%;height:100%;display:grid;place-items:center}
  .board{width:min(1200px,92vw);height:min(60vh,720px);border:1px solid #000;border-radius:14px;background:#0f141b;position:relative;box-shadow:inset 0 0 0 1px #000,0 10px 40px rgba(0,0,0,.45)}
  .grid{position:absolute;inset:0;background:linear-gradient(0deg,var(--grid) 1px,transparent 1px),linear-gradient(90deg,var(--grid) 1px,transparent 1px);background-size:calc(var(--grid-size)*1px) calc(var(--grid-size)*1px);opacity:.55;pointer-events:none}
  svg#canvas{position:absolute;inset:0}
  .palette{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
  .part{background:#0f141b;border:1px dashed #2a3340;border-radius:10px;padding:10px;cursor:grab;user-select:none;display:grid;place-items:center;font-size:12px;min-height:58px}
  .part svg{width:32px;height:32px;display:block;fill:currentColor}
  .item.selected{outline:2px solid var(--accent);outline-offset:2px}
  .hint{position:absolute;left:12px;bottom:10px;font-size:12px;color:#9fb0c2}
  .hint .chip{margin-left:6px;border:1px solid #2a3340;background:#1b2330;color:#cbd5e1;border-radius:8px;padding:4px 8px;cursor:pointer}
  .hint .chip:hover{background:#223042}
  .float-controls{position:absolute;display:none;gap:6px;background:#101721;border:1px solid #2a3340;border-radius:10px;padding:6px;box-shadow:0 6px 20px rgba(0,0,0,.4);z-index:10;pointer-events:auto}
  .float-controls .icon-btn{width:36px;height:36px}
  .float-controls .icon-btn svg{width:18px;height:18px}
  .debug-log{position:absolute;right:8px;top:8px;max-width:320px;max-height:40vh;overflow:auto;background:#0c1219cc;border:1px solid #2a3340;border-radius:8px;padding:6px;color:#9fb0c2;font-size:11px;z-index:20}
</style>
</head>
<body>
<aside>
  <h1>Realistic Car Builder</h1>
  <div class="row">
    <label>Body</label><input id="bodyColor" type="color" value="#e11d48">
    <label>Glass</label><input id="glassColor" type="color" value="#7dd3fc">
    <label>Rims</label><input id="rimColor" type="color" value="#d1d5db">
  </div>
  <div id="modeMenu" class="row" role="group" aria-label="Choose a mode">
    <button id="chooseNew" class="btn">Build New Car</button>
    <button id="chooseSaved" class="btn">My Saved Cars</button>
  </div>

  <section id="builderPanel" class="tab-panel" role="tabpanel" hidden>
    <div class="row">
      <button class="btn icon-btn" id="run2" aria-label="Run" title="Run">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M8 5v14l11-7z"></path>
        </svg>
        <span class="sr-only">Run</span>
      </button>
      <button class="btn icon-btn" id="stop2" aria-label="Stop" title="Stop">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <rect x="6" y="6" width="12" height="12" rx="2"></rect>
        </svg>
        <span class="sr-only">Stop</span>
      </button>
      <button class="btn icon-btn" id="saveCustom" aria-label="Save Car" title="Save Car">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M17 3H7a2 2 0 0 0-2 2v14l7-3 7 3V5a2 2 0 0 0-2-2z"></path>
        </svg>
        <span class="sr-only">Save Car</span>
      </button>
      <label>Speed</label>
      <select id="speed" class="btn">
        <option value="140">Slow</option>
        <option value="220" selected>Normal</option>
        <option value="320">Fast</option>
      </select>
    </div>
    <div class="row">
      <button class="btn icon-btn" id="clone" aria-label="Clone" title="Clone">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <rect x="4" y="7" width="10" height="10" rx="2" opacity="0.7"></rect>
          <rect x="9" y="4" width="11" height="11" rx="2"></rect>
        </svg>
        <span class="sr-only">Clone</span>
      </button>
      <button class="btn icon-btn" id="delete" aria-label="Delete" title="Delete">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <rect x="7" y="9" width="10" height="10" rx="2"></rect>
          <rect x="9" y="4" width="6" height="3" rx="1"></rect>
          <rect x="6" y="7" width="12" height="2" rx="1"></rect>
        </svg>
        <span class="sr-only">Delete</span>
      </button>
      <button class="btn icon-btn" id="clear" aria-label="Clear" title="Clear">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M3 14l6-7a2 2 0 0 1 3 0l6 6a2 2 0 0 1 0 3l-2 2H9L3 15z"></path>
        </svg>
        <span class="sr-only">Clear</span>
      </button>
    </div>
    <div class="row">
      <label>Snap</label>
      <select id="snap" class="btn">
        <option value="1">1x</option><option value="2">2x</option><option value="4">4x</option>
      </select>
    </div>

    <h1>Parts</h1>
    <div class="palette" id="palette">
      <div class="part" draggable="true" data-kind="body" aria-label="Car Body" title="Car Body">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M3 14c1.5-4.5 5-7 9-7h4c2 0 3 1.2 4 3l1 1v4a2 2 0 0 1-2 2h-1.2a2 2 0 0 1-2-2H8.2a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-1z"></path>
        </svg>
        <span class="sr-only">Car Body</span>
      </div>
      <div class="part" draggable="true" data-kind="roof" aria-label="Roof" title="Roof">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M4 12c3-3 7-4 12-4 1.5 0 3 .3 4 1l1 1" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
        </svg>
        <span class="sr-only">Roof</span>
      </div>
      <div class="part" draggable="true" data-kind="hood" aria-label="Hood" title="Hood">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M3 8c4-2 14-2 18 0v4c0 1-.7 2-1.6 2C14 15 10 15 4.6 14 3.7 14 3 13 3 12z"></path>
        </svg>
        <span class="sr-only">Hood</span>
      </div>
      <div class="part" draggable="true" data-kind="window" aria-label="Window" title="Window">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M6 9c3-1 9-1 12 0v4c0 1-.7 2-1.8 2-6 .8-9.4.8-12.4 0C2.7 14.7 4 13 4 13l2-4z" opacity="0.9"></path>
        </svg>
        <span class="sr-only">Window</span>
      </div>
      <div class="part" draggable="true" data-kind="wheel" aria-label="Wheel" title="Wheel">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <circle cx="12" cy="12" r="9"></circle>
          <circle cx="12" cy="12" r="4" fill="#0f141b"></circle>
          <g stroke="#0f141b" stroke-width="2">
            <line x1="12" y1="3" x2="12" y2="9"></line>
            <line x1="12" y1="15" x2="12" y2="21"></line>
            <line x1="3" y1="12" x2="9" y2="12"></line>
            <line x1="15" y1="12" x2="21" y2="12"></line>
          </g>
        </svg>
        <span class="sr-only">Wheel</span>
      </div>
      <div class="part" draggable="true" data-kind="headlight" aria-label="Headlight" title="Headlight">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <rect x="5" y="9" width="10" height="6" rx="3"></rect>
          <path d="M17 12h3M17 9h2M17 15h2" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
        </svg>
        <span class="sr-only">Headlight</span>
      </div>
      <div class="part" draggable="true" data-kind="foglight" aria-label="Fog Light" title="Fog Light">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <circle cx="12" cy="12" r="6"></circle>
        </svg>
        <span class="sr-only">Fog Light</span>
      </div>
      <div class="part" draggable="true" data-kind="taillight" aria-label="Taillight" title="Taillight">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <rect x="6" y="10" width="8" height="5" rx="2"></rect>
        </svg>
        <span class="sr-only">Taillight</span>
      </div>
      <div class="part" draggable="true" data-kind="frontbumper" aria-label="Front Bumper" title="Front Bumper">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <rect x="4" y="10" width="16" height="5" rx="2"></rect>
        </svg>
        <span class="sr-only">Front Bumper</span>
      </div>
      <div class="part" draggable="true" data-kind="rearbumper" aria-label="Rear Bumper" title="Rear Bumper">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <rect x="4" y="12" width="16" height="4" rx="2"></rect>
        </svg>
        <span class="sr-only">Rear Bumper</span>
      </div>
      <div class="part" draggable="true" data-kind="grille" aria-label="Grille" title="Grille">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <rect x="4" y="8" width="16" height="8" rx="3"></rect>
          <g fill="#0f141b">
            <rect x="6" y="9" width="2" height="6" rx="1"></rect>
            <rect x="9" y="9" width="2" height="6" rx="1"></rect>
            <rect x="12" y="9" width="2" height="6" rx="1"></rect>
            <rect x="15" y="9" width="2" height="6" rx="1"></rect>
          </g>
        </svg>
        <span class="sr-only">Grille</span>
      </div>
      <div class="part" draggable="true" data-kind="doorline" aria-label="Door Line" title="Door Line">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M4 14c3-1 7-1 10 0" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
        </svg>
        <span class="sr-only">Door Line</span>
      </div>
      <div class="part" draggable="true" data-kind="handle" aria-label="Door Handle" title="Door Handle">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <rect x="5" y="9" width="14" height="4" rx="2"></rect>
        </svg>
        <span class="sr-only">Door Handle</span>
      </div>
      <div class="part" draggable="true" data-kind="skirt" aria-label="Side Skirt" title="Side Skirt">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <rect x="3" y="16" width="18" height="3" rx="2"></rect>
        </svg>
        <span class="sr-only">Side Skirt</span>
      </div>
      <div class="part" draggable="true" data-kind="spoiler" aria-label="Spoiler" title="Spoiler">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M4 10h12c1.5 0 2.5-.6 3-1.2.5-.5.5-1.3 0-1.8C18.5 6.2 17.5 6 16 6H4z"></path>
        </svg>
        <span class="sr-only">Spoiler</span>
      </div>
      <div class="part" draggable="true" data-kind="license" aria-label="License Plate" title="License Plate">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <rect x="4" y="9" width="16" height="6" rx="2"></rect>
        </svg>
        <span class="sr-only">License Plate</span>
      </div>
      <div class="part" draggable="true" data-kind="exhaust" aria-label="Exhaust" title="Exhaust">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <rect x="4" y="11" width="12" height="4" rx="2"></rect>
          <circle cx="18" cy="13" r="2"></circle>
        </svg>
        <span class="sr-only">Exhaust</span>
      </div>
      <div class="part" draggable="true" data-kind="emblem" aria-label="Emblem" title="Emblem">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <circle cx="12" cy="12" r="5"></circle>
        </svg>
        <span class="sr-only">Emblem</span>
      </div>
      <div class="part" draggable="true" data-kind="stripe" aria-label="Side Stripe" title="Side Stripe">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <rect x="3" y="11" width="18" height="2" rx="1"></rect>
        </svg>
        <span class="sr-only">Side Stripe</span>
      </div>
      <div class="part" draggable="true" data-kind="mirror" aria-label="Mirror" title="Mirror">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <rect x="6" y="9" width="8" height="6" rx="2"></rect>
          <rect x="5" y="11" width="2" height="2" rx="1"></rect>
        </svg>
        <span class="sr-only">Mirror</span>
      </div>
    </div>

    <div class="legend">
      Drag parts to customize. R to rotate, arrows to nudge, Del to remove.
    </div>
  </section>

  <section id="savedPanelUI" class="tab-panel" role="tabpanel" hidden>
    <div class="row">
      <button class="btn" id="refreshSaved">Refresh</button>
    </div>
    <div id="savedList2" class="saved-list"></div>
  </section>

  <div class="legend">Assemble then Run. Wheels rotate while cars move.</div>
  <div id="savedPanel" class="saved-panel" role="dialog" aria-modal="true" aria-label="Saved Cars">
    <h2>My Cars</h2>
    <div id="savedList" class="saved-list"></div>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px">
      <button class="btn small" id="closeSaved">Close</button>
    </div>
  </div>
</aside>

<main>
  <div class="stage-wrap">
    <div class="board">
      <div class="grid"></div>
      <svg id="canvas" viewBox="0 0 1200 600" aria-label="Build area">
        <defs>
          <filter id="shadow" x="-50%" y="-50%" width="200%" height="200%">
            <feDropShadow dx="0" dy="4" stdDeviation="6" flood-color="#000" flood-opacity="0.45"/>
          </filter>
          <linearGradient id="glassGrad" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0" stop-color="#bfe6ff" stop-opacity=".85"/>
            <stop offset=".5" stop-color="#8bcaf0" stop-opacity=".6"/>
            <stop offset="1" stop-color="#5aa6d8" stop-opacity=".4"/>
          </linearGradient>
          <linearGradient id="chrome" x1="0" y1="0" x2="1" y2="0">
            <stop offset="0" stop-color="#f5f5f5"/>
            <stop offset=".3" stop-color="#a9a9a9"/>
            <stop offset=".6" stop-color="#ededed"/>
            <stop offset="1" stop-color="#a0a0a0"/>
          </linearGradient>
          <linearGradient id="bodyShine" x1="0" y1="0" x2="0" y2="1">
            <stop offset="0" stop-color="#ffffff" stop-opacity="0.35"/>
            <stop offset="0.4" stop-color="#ffffff" stop-opacity="0.15"/>
            <stop offset="0.65" stop-color="#ffffff" stop-opacity="0.06"/>
            <stop offset="1" stop-color="#ffffff" stop-opacity="0"/>
          </linearGradient>
          <radialGradient id="tyreGrad" cx="50%" cy="50%" r="50%">
            <stop offset="0" stop-color="#222"/>
            <stop offset="0.6" stop-color="#111"/>
            <stop offset="1" stop-color="#000"/>
          </radialGradient>
        </defs>
      </svg>
      <div id="floatControls" class="float-controls" aria-label="Selection tools">
        <button class="btn icon-btn" id="ctrlRotateL" title="Rotate Left" aria-label="Rotate Left">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 6v3l-4-4 4-4v3a8 8 0 1 1-8 8h2a6 6 0 1 0 6-6z"></path></svg>
        </button>
        <button class="btn icon-btn" id="ctrlRotateR" title="Rotate Right" aria-label="Rotate Right">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 6v3l4-4-4-4v3a8 8 0 1 0 8 8h-2a6 6 0 1 1-6-6z"></path></svg>
        </button>
        <button class="btn icon-btn" id="ctrlNudgeUp" title="Nudge Up" aria-label="Nudge Up">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 5l7 7h-4v7H9v-7H5z"></path></svg>
        </button>
        <button class="btn icon-btn" id="ctrlNudgeLeft" title="Nudge Left" aria-label="Nudge Left">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M5 12l7-7v4h7v6h-7v4z"></path></svg>
        </button>
        <button class="btn icon-btn" id="ctrlNudgeRight" title="Nudge Right" aria-label="Nudge Right">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M19 12l-7 7v-4H5V9h7V5z"></path></svg>
        </button>
        <button class="btn icon-btn" id="ctrlNudgeDown" title="Nudge Down" aria-label="Nudge Down">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 19l-7-7h4V5h6v7h4z"></path></svg>
        </button>
        <button class="btn icon-btn" id="ctrlClone" title="Clone" aria-label="Clone">
          <svg viewBox="0 0 24 24" aria-hidden="true"><rect x="4" y="7" width="10" height="10" rx="2" opacity="0.7"></rect><rect x="9" y="4" width="11" height="11" rx="2"></rect></svg>
        </button>
        <button class="btn icon-btn" id="ctrlDelete" title="Delete" aria-label="Delete">
          <svg viewBox="0 0 24 24" aria-hidden="true"><rect x="7" y="9" width="10" height="10" rx="2"></rect><rect x="9" y="4" width="6" height="3" rx="1"></rect><rect x="6" y="7" width="12" height="2" rx="1"></rect></svg>
        </button>
      </div>
      <div id="debugLog" class="debug-log" aria-live="polite"></div>
      <div class="hint">
        Shortcuts:
        <button id="hRotate" class="chip" title="Rotate (R)">R Rotate</button>
        <span>• Alt+Drag Clone</span>
        <button id="hClone" class="chip" title="Clone">Clone</button>
        <button id="hDelete" class="chip" title="Delete (Backspace)">⌫ Delete</button>
        <button id="hUp" class="chip" title="Nudge Up (↑)">↑</button>
        <button id="hLeft" class="chip" title="Nudge Left (←)">←</button>
        <button id="hRight" class="chip" title="Nudge Right (→)">→</button>
        <button id="hDown" class="chip" title="Nudge Down (↓)">↓</button>
      </div>
      <div id="demoCursor" class="demo-cursor" aria-hidden="true"></div>
    </div>
  </div>
</main>

<script>
(()=>{
  const SVGNS="http://www.w3.org/2000/svg";
  const canvas=document.getElementById('canvas');
  const board=document.querySelector('.board');
  const floatControls=document.getElementById('floatControls');
  const palette=document.getElementById('palette');
  const bodyColor=document.getElementById('bodyColor');
  const glassColor=document.getElementById('glassColor');
  const rimColor=document.getElementById('rimColor');
  const ctrlRotateL=document.getElementById('ctrlRotateL');
  const ctrlRotateR=document.getElementById('ctrlRotateR');
  const ctrlNudgeUp=document.getElementById('ctrlNudgeUp');
  const ctrlNudgeDown=document.getElementById('ctrlNudgeDown');
  const ctrlNudgeLeft=document.getElementById('ctrlNudgeLeft');
  const ctrlNudgeRight=document.getElementById('ctrlNudgeRight');
  const ctrlClone=document.getElementById('ctrlClone');
  const ctrlDelete=document.getElementById('ctrlDelete');
  const btnSaveAuto=document.getElementById('saveAuto');
  const btnSaveCustom=document.getElementById('saveCustom');
  const btnOpenSavedAuto=document.getElementById('openSavedAuto');
  const btnOpenSavedCustom=document.getElementById('openSavedCustom');
  const savedPanel=document.getElementById('savedPanel');
  const savedList=document.getElementById('savedList');
  const closeSaved=document.getElementById('closeSaved');

  // Layer groups for per-tab visibility
  const autoLayer=document.createElementNS(SVGNS,'g'); autoLayer.setAttribute('id','autoLayer');
  const customLayer=document.createElementNS(SVGNS,'g'); customLayer.setAttribute('id','customLayer');
  canvas.appendChild(autoLayer); canvas.appendChild(customLayer);
  let activeMode='custom';
  function getCurrentLayer(){ return activeMode==='auto' ? autoLayer : customLayer; }
  const btnAssemble=document.getElementById('assemble');
  const btnRun=null; // removed in demo
  const btnStop=null; // removed in demo
  const btnRun2=document.getElementById('run2');
  const btnStop2=document.getElementById('stop2');
  const btnNewAuto=document.getElementById('newAuto');
  const btnNewCustom=document.getElementById('newCustom');
  const btnDelCarAuto=document.getElementById('delCarAuto');
  const btnDelCarCustom=document.getElementById('delCarCustom');
  const speedSel=document.getElementById('speed');
  const btnDelete=document.getElementById('delete');
  const btnClone=document.getElementById('clone');
  const btnClear=document.getElementById('clear');
  const snapSel=document.getElementById('snap');
  const chooseNew=document.getElementById('chooseNew');
  const chooseSaved=document.getElementById('chooseSaved');
  const builderPanel=document.getElementById('builderPanel');
  const savedPanelUI=document.getElementById('savedPanelUI');
  const debugLog=document.getElementById('debugLog');
  const DEBUG=true; function dbg(label, data){ try{ console.log('[DBG]', label, data!==undefined?data:''); if(debugLog){ const line=document.createElement('div'); line.textContent = (data!==undefined? (label+': '+(typeof data==='string'?data:JSON.stringify(data))) : label); debugLog.appendChild(line); debugLog.scrollTop = debugLog.scrollHeight; } }catch(e){} }

  function showPanel(which){
    builderPanel.hidden = which!=='builder';
    savedPanelUI.hidden = which!=='saved';
  }
  chooseNew.addEventListener('click', ()=>{ activeMode='custom'; showPanel('builder'); dbg('chooseNew', {activeMode}); });
  chooseSaved.addEventListener('click', ()=>{ showPanel('saved'); dbg('chooseSaved'); renderSavedList2(); });
  // default landing: chooser only; panels hidden
  showPanel(null); dbg('init', {activeMode, runBtnPresent: !!document.getElementById('run2')});

  const GS=parseInt(getComputedStyle(document.documentElement).getPropertyValue('--grid-size'));
  let SNAP=1;
  let selected=null;

  // animation state
  let animId=null, vx=220; // px/sec
  const WHEEL_RADIUS=48; // matches wheel r
     const CARS=[]; // array of { group, wheelNodes, angle, x, y, mode }
   const running={ auto:false, custom:false };
   const projectName={ auto:null, custom:null };

  // ---------- utils ----------
  const attr=(el,o)=>{ for(const k in o) el.setAttribute(k,o[k]); return el; };
  function makeSelectable(el){ el.classList.add('item'); el.style.cursor='grab'; el.addEventListener('pointerdown', startDrag); el.addEventListener('click', ()=>select(el)); }
  function select(el){ if(selected) selected.classList.remove('selected'); selected=el; if(el) el.classList.add('selected'); updateControlsVisibility(); }
  function snap(v){ const step=GS*SNAP; return Math.round(v/step)*step; }
  function currentTranslate(el){ const t=el.getAttribute('transform')||""; const m=t.match(/translate\((-?\d+(\.\d+)?),\s*(-?\d+(\.\d+)?)\)/); return m?[parseFloat(m[1]),parseFloat(m[3])]:[0,0]; }
  function currentRotation(el){ const t=el.getAttribute('transform')||""; const m=t.match(/rotate\((-?\d+(\.\d+)?)\)/); return m?parseFloat(m[1]):0; }
  function setTranslate(el,tx,ty){ const rot=currentRotation(el); el.setAttribute('transform',`translate(${tx},${ty}) rotate(${rot})`); }
  function setTranslateOnly(el,tx,ty){ el.setAttribute('transform',`translate(${tx},${ty})`); }
  function rotateDelta(el,deg){ const [tx,ty]=currentTranslate(el); const rot=((currentRotation(el)+deg)%360+360)%360; el.setAttribute('transform',`translate(${tx},${ty}) rotate(${rot})`); }
  const svg=(tag,props)=>attr(document.createElementNS(SVGNS,tag),props);
  function svgGroup(kind){ const g=document.createElementNS(SVGNS,'g'); g.dataset.kind=kind; g.dataset.rot='0'; makeSelectable(g); return g; }
  function appendToCurrentLayer(node){ getCurrentLayer().appendChild(node); }

  // ---------- palette drag create ----------
  palette.querySelectorAll('.part').forEach(p=>{
    p.addEventListener('dragstart', e=>{ e.dataTransfer.setData('text/plain', p.dataset.kind); });
  });
  canvas.addEventListener('dragover', e=>e.preventDefault());
  canvas.addEventListener('drop', e=>{
    e.preventDefault();
    const kind=e.dataTransfer.getData('text/plain'); if(!kind) return;
    const rect=canvas.getBoundingClientRect(); const x=(e.clientX-rect.left); const y=(e.clientY-rect.top);
    const item=createPart(kind);
    getCurrentLayer().appendChild(item);
    place(item,x,y); select(item);
  });

  // ---------- parts ----------
  function createPart(kind){
    switch(kind){
      case 'body': return makeBody();
      case 'roof': return makeRoof();
      case 'window': return makeWindow();
      case 'wheel': return makeWheel(); // nested spin group
      case 'headlight': return makeHeadlight();
      case 'taillight': return makeTaillight();
      case 'grille': return makeGrille();
      case 'doorline': return makeDoorLine();
      case 'spoiler': return makeSpoiler();
      case 'mirror': return makeMirror();
      case 'hood': return makeHood();
      case 'frontbumper': return makeFrontBumper();
      case 'rearbumper': return makeRearBumper();
      case 'foglight': return makeFogLight();
      case 'license': return makeLicensePlate();
      case 'exhaust': return makeExhaust();
      case 'handle': return makeDoorHandle();
      case 'skirt': return makeSideSkirt();
      case 'emblem': return makeEmblem();
      case 'stripe': return makeSideStripe();
      default: return makeBody();
    }
  }

  function makeBody(){
    const g=svgGroup('body');
    // Main hull with smoother bumpers and rocker line
    const hull=svg('path',{d:
      "M 0 70 C 30 25, 150 0, 230 0 L 420 0 C 520 0, 610 18, 640 60 L 660 78 L 660 116 C 660 136, 642 152, 616 154 L 45 154 C 18 152, 0 138, 0 116 Z",
      fill:bodyColor.value,filter:"url(#shadow)"});
    // Lower shade to add depth
    const lowerShade=svg('path',{d:
      "M 18 130 C 180 152, 500 152, 642 130 L 642 146 L 18 146 Z",
      fill:"rgba(0,0,0,.08)"});
    // Subtle body highlight strip
    const shine=svg('path',{d:
      "M 36 18 C 180 -8, 520 -8, 620 18 C 640 26, 650 44, 632 56 C 520 70, 220 70, 100 56 C 72 44, 60 26, 36 18 Z",
      fill:"url(#bodyShine)"});
    // Side trim
    const trim=svg('rect',{x:12,y:124,width:636,height:8,rx:4,ry:4,fill:"rgba(0,0,0,.28)"});
    // Fender suggestions above wheels
    const fenderRear=svg('path',{d:"M 90 118 C 130 96, 180 96, 220 118",fill:"none",stroke:"rgba(0,0,0,.35)","stroke-width":4});
    const fenderFront=svg('path',{d:"M 470 118 C 510 96, 560 96, 600 118",fill:"none",stroke:"rgba(0,0,0,.35)","stroke-width":4});
    g.append(hull,lowerShade,shine,trim,fenderRear,fenderFront);
    return g;
  }
  function makeRoof(){
    const g=svgGroup('roof');
    g.append(svg('path',{d:"M 140 0 C 220 -20, 460 -20, 540 0 L 560 10 L 560 30 C 560 40, 550 50, 540 55 C 460 70, 220 70, 140 55 C 130 50, 120 40, 120 30 L 120 10 Z",fill:bodyColor.value,filter:"url(#shadow)"}));
    return g;
  }
  function makeWindow(){
    const g=svgGroup('window');
    const glass=svg('path',{d:"M 160 10 C 240 -5, 440 -5, 520 10 L 520 45 C 520 55, 510 65, 500 68 C 420 80, 260 80, 180 68 C 170 65, 160 55, 160 45 Z",fill:"url(#glassGrad)",opacity:"0.95",filter:"url(#shadow)"});
    // Tint overlay from color picker
    const tint=svg('path',{d:"M 160 10 C 240 -5, 440 -5, 520 10 L 520 45 C 520 55, 510 65, 500 68 C 420 80, 260 80, 180 68 C 170 65, 160 55, 160 45 Z",fill:glassColor.value,opacity:"0.35"});
    const streak=svg('path',{d:"M 190 20 C 260 10, 430 10, 500 20 L 500 24 C 430 34, 260 34, 190 24 Z",fill:"#fff",opacity:"0.25"});
    g.append(glass,tint,streak); return g;
  }

  // WHEEL FIX: outer group translates, inner ".spin" rotates around (0,0)
  function makeWheel(){
    const outer=svgGroup('wheel'); // selectable, draggable
    const spin=document.createElementNS(SVGNS,'g');
    spin.classList.add('spin');

    const tyre=svg('circle',{cx:0,cy:0,r:WHEEL_RADIUS,fill:"url(#tyreGrad)",stroke:"#0a0a0a","stroke-width":2,filter:"url(#shadow)"});
    const brake=svg('circle',{cx:0,cy:0,r:22,fill:"#bbb",opacity:"0.6"});
    const rim=svg('circle',{cx:0,cy:0,r:34,fill:rimColor.value,stroke:"#ffffff","stroke-opacity":"0.15","stroke-width":2});
    spin.append(tyre,brake,rim);
    for(let i=0;i<10;i++){ spin.append(svg('rect',{x:-2,y:-30,width:4,height:28,fill:"#888",rx:1,ry:1,transform:`rotate(${i*36})`})); }
    const hub=svg('circle',{cx:0,cy:0,r:8,fill:"#666"});
    spin.append(hub);

    outer.append(spin);
    return outer;
  }

  function makeGroundShadow(){
    // Wide, soft shadow under the car
    return svg('ellipse',{cx:310,cy:180,rx:420,ry:36,fill:"rgba(0,0,0,.22)"});
  }

  function makeHeadlight(){ const g=svgGroup('headlight'); g.append(svg('rect',{x:0,y:0,rx:8,ry:8,width:34,height:18,fill:"#fef3c7",stroke:"#eab308","stroke-width":2,filter:"url(#shadow)"})); return g; }
  function makeTaillight(){ const g=svgGroup('taillight'); g.append(svg('rect',{x:0,y:0,rx:8,ry:8,width:34,height:18,fill:"#fecaca",stroke:"#ef4444","stroke-width":2,filter:"url(#shadow)"})); return g; }
  function makeGrille(){ const g=svgGroup('grille'); g.append(svg('rect',{x:0,y:0,rx:10,ry:10,width:80,height:26,fill:"url(#chrome)",filter:"url(#shadow)"})); for(let i=0;i<5;i++) g.append(svg('rect',{x:8+i*14,y:4,width:8,height:18,fill:"#1f2937"})); return g; }
  function makeDoorLine(){ const g=svgGroup('doorline'); g.append(svg('path',{d:"M 0 0 C 40 -10, 120 -10, 160 0",stroke:"#1f2937","stroke-width":3,fill:"none"})); return g; }
  function makeSpoiler(){ const g=svgGroup('spoiler'); g.append(svg('path',{d:"M 0 0 L 80 0 C 90 0, 96 -8, 96 -14 C 96 -18, 92 -22, 88 -22 L 0 -22 Z",fill:bodyColor.value,filter:"url(#shadow)"})); return g; }
  function makeMirror(){ const g=svgGroup('mirror'); g.append(svg('rect',{x:0,y:0,width:16,height:10,rx:3,ry:3,fill:bodyColor.value,filter:"url(#shadow)"}), svg('rect',{x:2,y:2,width:12,height:6,rx:2,ry:2,fill:glassColor.value})); return g; }

  // Additional realistic parts
  function makeHood(){
    const g=svgGroup('hood');
    const panel=svg('path',{d:"M 0 0 C 60 -10, 240 -10, 300 0 L 300 16 C 300 24, 292 30, 284 32 C 220 44, 80 44, 16 32 C 8 30, 0 24, 0 16 Z", fill: bodyColor.value, filter:"url(#shadow)"});
    const crease=svg('path',{d:"M 40 8 C 120 2, 180 2, 260 8", stroke:"rgba(255,255,255,.3)", 'stroke-width':2, fill:"none"});
    g.append(panel, crease);
    return g;
  }
  function makeFrontBumper(){
    const g=svgGroup('frontbumper');
    const b=svg('path',{d:"M 0 0 L 200 0 C 212 0, 222 8, 222 16 C 222 22, 216 28, 210 28 L 0 28 Z", fill: bodyColor.value, filter:"url(#shadow)"});
    const lip=svg('rect',{x:4,y:22,width:210,height:6,rx:3,ry:3,fill:"#0b0f14",opacity:"0.5"});
    g.append(b,lip); return g;
  }
  function makeRearBumper(){
    const g=svgGroup('rearbumper');
    const b=svg('path',{d:"M 0 0 L 180 0 C 192 0, 200 6, 200 12 C 200 18, 192 24, 180 24 L 0 24 Z", fill: bodyColor.value, filter:"url(#shadow)"});
    g.append(b); return g;
  }
  function makeFogLight(){
    const g=svgGroup('foglight');
    g.append(svg('circle',{cx:10,cy:10,r:10,fill:'#fde68a',stroke:'#f59e0b','stroke-width':2,filter:"url(#shadow)"}));
    return g;
  }
  function makeLicensePlate(){
    const g=svgGroup('license');
    g.append(svg('rect',{x:0,y:0,width:80,height:20,rx:4,ry:4,fill:'#e5e7eb',stroke:'#9ca3af','stroke-width':2,filter:"url(#shadow)"}));
    g.append(svg('rect',{x:6,y:4,width:12,height:12,rx:2,ry:2,fill:'#3b82f6'}));
    return g;
  }
  function makeExhaust(){
    const g=svgGroup('exhaust');
    const pipe=svg('rect',{x:0,y:6,width:40,height:8,rx:4,ry:4,fill:'url(#chrome)',filter:"url(#shadow)"});
    const tip=svg('circle',{cx:44,cy:10,r:6,fill:'#111',stroke:'#e5e7eb','stroke-width':2});
    g.append(pipe,tip); return g;
  }
  function makeDoorHandle(){
    const g=svgGroup('handle');
    g.append(svg('rect',{x:0,y:0,width:36,height:10,rx:5,ry:5,fill:'url(#chrome)',filter:"url(#shadow)"}));
    return g;
  }
  function makeSideSkirt(){
    const g=svgGroup('skirt');
    g.append(svg('rect',{x:0,y:0,width:220,height:10,rx:5,ry:5,fill:'#0b0f14',opacity:'0.7',filter:"url(#shadow)"}));
    return g;
  }
  function makeEmblem(){
    const g=svgGroup('emblem');
    g.append(svg('circle',{cx:10,cy:10,r:10,fill:'url(#chrome)',filter:"url(#shadow)"}));
    g.append(svg('text',{x:10,y:14,'font-size':10,'text-anchor':'middle',fill:'#111'},));
    return g;
  }
  function makeSideStripe(){
    const g=svgGroup('stripe');
    const stripe=svg('rect',{x:0,y:0,width:240,height:6,rx:3,ry:3,fill:'#93c5fd',opacity:'0.85',filter:"url(#shadow)"});
    g.append(stripe); return g;
  }

  // ---------- placing / dragging / rotate ----------
  function place(el,x,y){
    const bbox=el.getBBox();
    const nx=snap(x - bbox.width/2);
    const ny=snap(y - bbox.height/2);
    setTranslateOnly(el,nx,ny);
  }

  let dragging=null, dragStart=null, initT=null;
  function startDrag(e){
    if(e.button!==0) return;
    let target=e.currentTarget;
    if(e.altKey) target=cloneItem(e.currentTarget);
    select(target);
    dragging=target; dragStart={x:e.clientX,y:e.clientY}; initT=currentTranslate(target);
    e.currentTarget.setPointerCapture(e.pointerId);
    e.preventDefault(); e.stopPropagation();
    window.addEventListener('pointermove', onDrag);
    window.addEventListener('pointerup', endDrag, {once:true});
  }
  function onDrag(e){
    if(!dragging) return;
    const dx=e.clientX - dragStart.x, dy=e.clientY - dragStart.y;
    const nx=snap(initT[0]+dx), ny=snap(initT[1]+dy);
    setTranslateOnly(dragging,nx,ny);
    updateControlsPosition();
  }
  function endDrag(){ dragging=null; window.removeEventListener('pointermove', onDrag); }

  window.addEventListener('keydown', e=>{
    if(!selected) return;
    if(e.key.toLowerCase()==='r'){ rotateDelta(selected,90); }
    else if(['ArrowLeft','ArrowRight','ArrowUp','ArrowDown'].includes(e.key)){
      const [tx,ty]=currentTranslate(selected); const step=GS*SNAP;
      const d={ArrowLeft:[-step,0],ArrowRight:[step,0],ArrowUp:[0,-step],ArrowDown:[0,step]}[e.key];
      setTranslateOnly(selected,tx+d[0],ty+d[1]); e.preventDefault();
    } else if(e.key==='Delete' || e.key==='Backspace'){ selected.remove(); selected=null; }
  });
  snapSel.addEventListener('change', ()=>{ SNAP=parseInt(snapSel.value)||1; });

  // ---------- clone / delete / clear ----------
  function cloneItem(el){ const clone=el.cloneNode(true); makeSelectable(clone); const [tx,ty]=currentTranslate(el); setTranslateOnly(clone,tx+GS,ty+GS); (el.parentNode||getCurrentLayer()).appendChild(clone); return clone; }
  btnClone.addEventListener('click', ()=>{ if(!selected) return; select(cloneItem(selected)); });
  btnDelete.addEventListener('click', ()=>{ if(!selected) return; selected.remove(); selected=null; });
  btnClear.addEventListener('click', ()=>{ stopAnim(); const layer=getCurrentLayer(); [...layer.querySelectorAll('.item')].forEach(n=>n.remove()); [...layer.querySelectorAll('g.car')].forEach(n=>n.remove()); selected=null; // prune cars from this layer
    for(let i=CARS.length-1;i>=0;i--){ if(CARS[i].group.parentNode===layer) CARS.splice(i,1); } });

  // ---------- Assemble preset as one group ----------
  if(btnAssemble) btnAssemble.addEventListener('click', ()=>{
    const layer=getCurrentLayer();
    const carGroup=document.createElementNS(SVGNS,'g');
    carGroup.classList.add('car');
    carGroup.dataset.mode=activeMode;
    layer.appendChild(carGroup);

    const originX=220, originY=290;

    const shadow=makeGroundShadow(); setTranslateOnly(shadow,originX,originY);
    const body=makeBody();      setTranslateOnly(body,originX,originY);
    const roof=makeRoof();      setTranslateOnly(roof,originX+60,originY-58);
    const win =makeWindow();    setTranslateOnly(win, originX+70,originY-56);

    const rear=makeWheel();     setTranslateOnly(rear,originX+120,originY+120);
    const front=makeWheel();    setTranslateOnly(front,originX+500,originY+120);

    const head=makeHeadlight(); setTranslateOnly(head,originX+635,originY+40);
    const tail=makeTaillight(); setTranslateOnly(tail,originX-10,originY+48);
    const grill=makeGrille();   setTranslateOnly(grill,originX+588,originY+64);
    const mir =makeMirror();    setTranslateOnly(mir, originX+520,originY-26);
    const spl =makeSpoiler();   setTranslateOnly(spl, originX-6, originY-8);
    const dl  =makeDoorLine();  setTranslateOnly(dl,  originX+250,originY+12);

    [shadow,body,roof,win,rear,front,head,tail,grill,mir,spl,dl].forEach(n=>carGroup.appendChild(n));
    // set initial transform and register the car with staggered starting X
    const idx=CARS.length;
    const startX = -400 - idx*220;
    const startY = 0;
    registerCar(carGroup, startX, startY, activeMode);
  });

  // Helpers for multi-car support
  function collectWheelNodes(group){
    return [...group.querySelectorAll('[data-kind="wheel"] > .spin')];
  }
  function registerCar(group, x=0, y=0, mode=null){
    if(!mode){ mode = group.dataset.mode || (group.parentNode===autoLayer?'auto':'custom'); }
    group.dataset.mode=mode;
    setTranslateOnly(group, x, y);
    const car={ group, wheelNodes: collectWheelNodes(group), angle:0, x, y, mode };
    if(!CARS.find(c=>c.group===group)){ CARS.push(car); dbg('registerCar', {mode, x, y, wheels: car.wheelNodes.length}); }
    return car;
  }
  function ensureCarsForRun(){
    // Register any existing cars in the active layer
    const layer=getCurrentLayer();
    const groups=[...layer.querySelectorAll('g.car')];
    groups.forEach(g=>{ registerCar(g, currentTranslate(g)[0], currentTranslate(g)[1], activeMode); });
    dbg('ensureCarsForRun: groups', groups.length);
    if(CARS.some(c=>c.mode===activeMode)){ dbg('ensureCarsForRun: existing car found'); return true; }
    // If still no cars exist in this mode, wrap loose items in this layer
    const items=[...layer.querySelectorAll('.item')];
    dbg('ensureCarsForRun: items', items.length);
    if(items.length===0){ dbg('ensureCarsForRun: no items'); return false; }
    const g=document.createElementNS(SVGNS,'g');
    g.classList.add('car');
    g.dataset.mode=activeMode;
    layer.appendChild(g);
    items.forEach(n=>g.appendChild(n));
    // start at current position (on-screen)
    registerCar(g, 0, 0, activeMode);
    dbg('ensureCarsForRun: wrapped items into car');
    return true;
  }

  // ---------- Run / Stop animation ----------
  let lastT=null; if(speedSel){ speedSel.addEventListener('change', ()=>{ vx=parseFloat(speedSel.value)||220; dbg('speed change', vx); }); }
  // Auto tab is demo-only; Run exists only in Custom tab
  if(btnRun2){ btnRun2.addEventListener('click', ()=>{ dbg('Run clicked'); activeMode='custom'; const ok=ensureCarsForRun(); dbg('ensure result', ok); if(!ok){ alert('Build a car in this tab or click My Saved Cars to load one.'); return; } running.custom=true; dbg('set running.custom', running.custom); startAnim(); }); } else { dbg('Run button not found'); }
  function stopMode(mode){ running[mode]=false; if(!running.auto && !running.custom && animId){ cancelAnimationFrame(animId); animId=null; } }
  if(btnStop2){ btnStop2.addEventListener('click', ()=>{ dbg('Stop clicked'); stopMode('custom'); }); }

  function startAnim(){ if(animId){ dbg('startAnim: already running'); return; } lastT=performance.now(); dbg('startAnim'); animId=requestAnimationFrame(tick); }
  function stopAnim(){ if(animId){ cancelAnimationFrame(animId); animId=null; } running.auto=false; running.custom=false; dbg('stopAnim'); }

  function clearActiveLayer(){
    // stop only current mode
    stopMode(activeMode);
    const layer=getCurrentLayer();
    [...layer.querySelectorAll('.item')].forEach(n=>n.remove());
    [...layer.querySelectorAll('g.car')].forEach(n=>n.remove());
    selected=null;
    // prune cars from this layer
    for(let i=CARS.length-1;i>=0;i--){ if(CARS[i].group.parentNode===layer) CARS.splice(i,1); }
  }
  function layerHasContent(){
    const layer=getCurrentLayer();
    return layer.querySelector('.item') || layer.querySelector('g.car');
  }
  function collectCurrentParts(){
    const carGroup=getActiveLayerCarFromSelection();
    if(carGroup) return serializeCarFromGroup(carGroup);
    return serializeLooseItemsInLayer();
  }
  function saveEntry(name, parts){
    const entry={ id:uid(), name, mode:activeMode, colors:{ body:bodyColor.value, glass:glassColor.value, rim:rimColor.value }, parts };
    const list=loadSaved(); list.push(entry); saveAll(list);
  }
  function newCarFlow(){
    if(layerHasContent()){
      const parts=collectCurrentParts();
      if(parts && parts.length){
        const name=prompt('Save current car before clearing. Enter a name or leave blank to skip:','My Car');
        if(name) saveEntry(name, parts);
      }
    }
    clearActiveLayer();
    const name=prompt('Enter new car name to begin:','My New Car');
    if(!name){ alert('Please create a new car by pressing + and entering a name before building.'); return; }
    projectName[activeMode]=name;
  }
  if(btnNewAuto) btnNewAuto.addEventListener('click', newCarFlow);
  if(btnNewCustom) btnNewCustom.addEventListener('click', newCarFlow);

  function deleteCurrentCar(){
    const layer=getCurrentLayer();
    let targetCar=null;
    if(selected) targetCar=selected.closest('g.car');
    if(!targetCar){ const cars=[...layer.querySelectorAll('g.car')]; if(cars.length===1) targetCar=cars[0]; }
    if(!targetCar){ alert('Select a car to delete (or ensure only one car exists in this tab).'); return; }
    // remove car group and prune registry
    targetCar.remove();
    for(let i=CARS.length-1;i>=0;i--){ if(CARS[i].group===targetCar) CARS.splice(i,1); }
    if(selected && !document.body.contains(selected)) selected=null;
  }
  if(btnDelCarAuto) btnDelCarAuto.addEventListener('click', deleteCurrentCar);
  if(btnDelCarCustom) btnDelCarCustom.addEventListener('click', deleteCurrentCar);

  function tick(ts){
    const dt=(ts - lastT)/1000; lastT=ts;

    const dx=vx*dt;
    const circumference=2*Math.PI*WHEEL_RADIUS;
    const dAngle=(dx/circumference)*360;

    const viewW=1200;
    let anyRunning=false;
    for(const car of CARS){
      if(!running[car.mode]) continue;
      anyRunning=true;
      car.x += vx*dt;
      setTranslateOnly(car.group,car.x,car.y);
      car.angle = (car.angle + dAngle) % 360;
      car.wheelNodes.forEach(spin=>{ spin.setAttribute('transform',`rotate(${car.angle})`); });
      if(car.x > viewW + 200){ car.x = -400; }
    }

    if(anyRunning){ animId=requestAnimationFrame(tick); } else { dbg('tick: no cars running'); animId=null; }
  }

  // background click unselect
  canvas.addEventListener('pointerdown', e=>{ if(e.target===canvas) select(null); });

  // ---------- floating controls ----------
  function updateControlsVisibility(){
    if(!selected){ floatControls.style.display='none'; return; }
    floatControls.style.display='flex';
    updateControlsPosition();
  }
  function updateControlsPosition(){
    if(!selected || floatControls.style.display==='none') return;
    // ensure measurable size
    const prevVis=floatControls.style.visibility;
    floatControls.style.visibility='hidden';
    const boardRect=board.getBoundingClientRect();
    const selRect=selected.getBoundingClientRect();
    floatControls.style.visibility=prevVis||'';
    // place above selection, clamped to board
    const desiredLeft = selRect.left - boardRect.left + (selRect.width/2) - (floatControls.offsetWidth/2);
    const desiredTop = selRect.top - boardRect.top - floatControls.offsetHeight - 8;
    const left = Math.max(8, Math.min(desiredLeft, boardRect.width - floatControls.offsetWidth - 8));
    const top = Math.max(8, desiredTop);
    floatControls.style.left = left + 'px';
    floatControls.style.top = top + 'px';
  }
  window.addEventListener('resize', updateControlsPosition);

  ctrlRotateL.addEventListener('click', ()=>{ if(!selected) return; rotateDelta(selected,-90); updateControlsPosition(); });
  ctrlRotateR.addEventListener('click', ()=>{ if(!selected) return; rotateDelta(selected,90); updateControlsPosition(); });
  function nudge(dx,dy){ if(!selected) return; const [tx,ty]=currentTranslate(selected); const step=GS*SNAP; setTranslateOnly(selected,tx+dx*step,ty+dy*step); updateControlsPosition(); }
  ctrlNudgeUp.addEventListener('click', ()=>nudge(0,-1));
  ctrlNudgeDown.addEventListener('click', ()=>nudge(0,1));
  ctrlNudgeLeft.addEventListener('click', ()=>nudge(-1,0));
  ctrlNudgeRight.addEventListener('click', ()=>nudge(1,0));
  ctrlClone.addEventListener('click', ()=>{ if(!selected) return; const c=cloneItem(selected); select(c); updateControlsPosition(); });
  ctrlDelete.addEventListener('click', ()=>{ if(!selected) return; selected.remove(); select(null); });

  // ---------- hint chips (clickable shortcuts) ----------
  const hRotate=document.getElementById('hRotate');
  const hClone=document.getElementById('hClone');
  const hDelete=document.getElementById('hDelete');
  const hUp=document.getElementById('hUp');
  const hDown=document.getElementById('hDown');
  const hLeft=document.getElementById('hLeft');
  const hRight=document.getElementById('hRight');
  if(hRotate) hRotate.addEventListener('click', ()=>{ if(!selected) return; rotateDelta(selected,90); updateControlsPosition(); });
  if(hClone) hClone.addEventListener('click', ()=>{ if(!selected) return; const c=cloneItem(selected); select(c); updateControlsPosition(); });
  if(hDelete) hDelete.addEventListener('click', ()=>{ if(!selected) return; selected.remove(); select(null); });
  if(hUp) hUp.addEventListener('click', ()=>nudge(0,-1));
  if(hDown) hDown.addEventListener('click', ()=>nudge(0,1));
  if(hLeft) hLeft.addEventListener('click', ()=>nudge(-1,0));
  if(hRight) hRight.addEventListener('click', ()=>nudge(1,0));

  // ---------- Save / Load using localStorage ----------
  const STORAGE_KEY='cargame:savedCars:v1';
  function loadSaved(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]'); }catch{ return []; } }
  function saveAll(list){ localStorage.setItem(STORAGE_KEY, JSON.stringify(list)); }
  function uid(){ return Math.random().toString(36).slice(2)+Date.now().toString(36); }
  function getActiveLayerCarFromSelection(){
    const layer=getCurrentLayer();
    if(selected){ const car=selected.closest('g.car'); if(car && car.parentNode===layer) return car; }
    const cars=[...layer.querySelectorAll('g.car')];
    if(cars.length===1) return cars[0];
    return null;
  }
  function serializeCarFromGroup(carGroup){
    const parts=[...carGroup.children].filter(n=>n.dataset && n.dataset.kind).map(n=>{
      const [tx,ty]=currentTranslate(n);
      const rot=currentRotation(n);
      return { kind:n.dataset.kind, tx, ty, rot };
    });
    return parts;
  }
  function serializeLooseItemsInLayer(){
    const layer=getCurrentLayer();
    const items=[...layer.querySelectorAll('.item')];
    if(items.length===0) return null;
    return items.map(n=>{ const [tx,ty]=currentTranslate(n); const rot=currentRotation(n); return {kind:n.dataset.kind||'body', tx, ty, rot}; });
  }
  function promptAndSave(){
    // Ask for a name at save time
    const name=prompt('Name this car:','My Car');
    if(!name) return;
    // Gather parts
    const carGroup=getActiveLayerCarFromSelection();
    let parts=null;
    if(carGroup){ parts=serializeCarFromGroup(carGroup); }
    else { parts=serializeLooseItemsInLayer(); }
    if(!parts || parts.length===0){ alert('Nothing to save. Select a car or add parts.'); return; }
    const entry={ id:uid(), name, mode:activeMode, colors:{ body:bodyColor.value, glass:glassColor.value, rim:rimColor.value }, parts };
    const list=loadSaved(); list.push(entry); saveAll(list); alert('Saved as "'+name+'"');
  }
  function renderSavedList(){
    const list=loadSaved(); savedList.innerHTML='';
    if(list.length===0){ savedList.innerHTML='<div style="padding:8px;color:#9fb0c2">No saved cars yet.</div>'; return; }
    list.forEach(e=>{
      const row=document.createElement('div'); row.className='saved-item';
      const name=document.createElement('div'); name.className='name'; name.textContent=e.name;
      const actions=document.createElement('div'); actions.style.display='flex'; actions.style.gap='6px';
      const loadBtn=document.createElement('button'); loadBtn.className='btn small'; loadBtn.textContent='Load';
      const delBtn=document.createElement('button'); delBtn.className='btn small'; delBtn.textContent='Delete';
      loadBtn.addEventListener('click', ()=>loadCarEntry(e));
      delBtn.addEventListener('click', ()=>{ const all=loadSaved().filter(x=>x.id!==e.id); saveAll(all); renderSavedList(); });
      actions.append(loadBtn, delBtn);
      row.append(name, actions);
      savedList.append(row);
    });
  }
  function openSaved(){ savedPanel.style.display='block'; renderSavedList(); }
  function closeSavedPanel(){ savedPanel.style.display='none'; }
  closeSaved.addEventListener('click', closeSavedPanel);
  if(btnOpenSavedAuto) btnOpenSavedAuto.addEventListener('click', openSaved);
  if(btnOpenSavedCustom) btnOpenSavedCustom.addEventListener('click', openSaved);
  if(btnSaveAuto) btnSaveAuto.addEventListener('click', promptAndSave);
  if(btnSaveCustom) btnSaveCustom.addEventListener('click', promptAndSave);
  function loadCarEntry(entry){
    // Clear current layer before loading
    clearActiveLayer();
    // Set project name to loaded car name
    projectName[activeMode]=entry.name;
    // temporarily set colors
    const prev={ body:bodyColor.value, glass:glassColor.value, rim:rimColor.value };
    bodyColor.value=entry.colors.body; glassColor.value=entry.colors.glass; rimColor.value=entry.colors.rim;
    const layer=getCurrentLayer();
    const carGroup=document.createElementNS(SVGNS,'g'); carGroup.classList.add('car'); carGroup.dataset.mode=activeMode; layer.appendChild(carGroup);
    entry.parts.forEach(p=>{
      const part=createPart(p.kind); carGroup.appendChild(part);
      setTranslateOnly(part, p.tx, p.ty); if(p.rot) rotateDelta(part, p.rot);
    });
    registerCar(carGroup, 0, 0, activeMode);
    // restore picker colors to previous values (we already applied them to the loaded car)
    bodyColor.value=prev.body; glassColor.value=prev.glass; rimColor.value=prev.rim;
    // show builder controls now that a car is loaded
    showPanel('builder');
  }
  function renderSavedList2(){
    const list=loadSaved(); const host=document.getElementById('savedList2'); if(!host) return; host.innerHTML='';
    if(list.length===0){ host.innerHTML='<div style="padding:8px;color:#9fb0c2">No saved cars yet.</div>'; return; }
    list.forEach(e=>{
      const row=document.createElement('div'); row.className='saved-item';
      const name=document.createElement('div'); name.className='name'; name.textContent=e.name;
      const actions=document.createElement('div'); actions.style.display='flex'; actions.style.gap='6px';
      const loadBtn=document.createElement('button'); loadBtn.className='btn small'; loadBtn.textContent='Load & Edit';
      const delBtn=document.createElement('button'); delBtn.className='btn small'; delBtn.textContent='Delete';
      loadBtn.addEventListener('click', ()=>{ activeMode='custom'; customLayer.style.display=''; autoLayer.style.display='none'; loadCarEntry(e); });
      delBtn.addEventListener('click', ()=>{ const all=loadSaved().filter(x=>x.id!==e.id); saveAll(all); renderSavedList2(); });
      actions.append(loadBtn, delBtn);
      row.append(name, actions);
      host.append(row);
    });
  }

  // ---------- Auto tab demo ----------
  const demoPlay=document.getElementById('demoPlay');
  const demoStop=document.getElementById('demoStop');
  function setupDemo(){
    // build one demo car in auto layer if none
    const anyAuto=autoLayer.querySelector('g.car');
    if(anyAuto) return;
    const g=document.createElementNS(SVGNS,'g'); g.classList.add('car'); g.dataset.mode='auto'; autoLayer.appendChild(g);
    const originX=120, originY=260;
    const shadow=makeGroundShadow(); setTranslateOnly(shadow,originX,originY);
    const body=makeBody();      setTranslateOnly(body,originX,originY);
    const roof=makeRoof();      setTranslateOnly(roof,originX+60,originY-58);
    const win =makeWindow();    setTranslateOnly(win, originX+70,originY-56);
    const rear=makeWheel();     setTranslateOnly(rear,originX+120,originY+120);
    const front=makeWheel();    setTranslateOnly(front,originX+500,originY+120);
    const head=makeHeadlight(); setTranslateOnly(head,originX+635,originY+40);
    const tail=makeTaillight(); setTranslateOnly(tail,originX-10,originY+48);
    const grill=makeGrille();   setTranslateOnly(grill,originX+588,originY+64);
    const mir =makeMirror();    setTranslateOnly(mir, originX+520,originY-26);
    const spl =makeSpoiler();   setTranslateOnly(spl, originX-6, originY-8);
    const dl  =makeDoorLine();  setTranslateOnly(dl,  originX+250,originY+12);
    [shadow,body,roof,win,rear,front,head,tail,grill,mir,spl,dl].forEach(n=>g.appendChild(n));
    registerCar(g, -300, 0, 'auto');
  }
  // Demo cursor and sequence
  const demoCursor=document.getElementById('demoCursor');
  let demoTimers=[]; let demoAnimating=false;
  function clearDemo(){ demoTimers.forEach(t=>clearTimeout(t)); demoTimers=[]; demoAnimating=false; demoCursor.style.display='none'; }
  function getCenter(el){ const r=el.getBoundingClientRect(); return {x:r.left + r.width/2, y:r.top + r.height/2}; }
  function moveCursorTo(x,y,duration=600){ return new Promise(resolve=>{
    const startRect=demoCursor.getBoundingClientRect();
    const startX=startRect.left+startRect.width/2, startY=startRect.top+startRect.height/2;
    const t0=performance.now();
    function step(t){ const p=Math.min(1,(t-t0)/duration); const nx=startX + (x-startX)*p; const ny=startY + (y-startY)*p; positionCursor(nx,ny); if(p<1 && demoAnimating) requestAnimationFrame(step); else resolve(); }
    requestAnimationFrame(step);
  }); }
  function positionCursor(pageX,pageY){ const boardRect=document.querySelector('.board').getBoundingClientRect(); demoCursor.style.left=(pageX - boardRect.left)+'px'; demoCursor.style.top=(pageY - boardRect.top)+'px'; }
  function pageToCanvas(px,py){ const r=canvas.getBoundingClientRect(); return {x:px - r.left, y:py - r.top}; }
  async function runDemo(){
    clearActiveLayer(); setupDemo(); // start fresh then build anim steps on top
    demoAnimating=true; demoCursor.style.display='block';
    // start cursor at first palette item
    const first=document.querySelector('#demoPalette [data-kind="body"]'); const c1=getCenter(first); positionCursor(c1.x,c1.y);
    await moveCursorTo(c1.x,c1.y,300);
    // drag to canvas position
    const target={x:260,y:300}; const tgtPage=canvas.getBoundingClientRect(); const tx=tgtPage.left+target.x, ty=tgtPage.top+target.y;
    await moveCursorTo(tx,ty,900); // pretend drag
    // place body
    const body=makeBody(); autoLayer.appendChild(body); setTranslateOnly(body,target.x,target.y);
    // wheel rear
    const wIcon=document.querySelector('#demoPalette [data-kind="wheel"]'); const cw=getCenter(wIcon); await moveCursorTo(cw.x,cw.y,500); await moveCursorTo(tgtPage.left+target.x+120, tgtPage.top+target.y+120, 800); const w1=makeWheel(); autoLayer.appendChild(w1); setTranslateOnly(w1,target.x+120,target.y+120);
    // wheel front
    await moveCursorTo(cw.x,cw.y,500); await moveCursorTo(tgtPage.left+target.x+500, tgtPage.top+target.y+120, 800); const w2=makeWheel(); autoLayer.appendChild(w2); setTranslateOnly(w2,target.x+500,target.y+120);
    // window
    const winIcon=document.querySelector('#demoPalette [data-kind="window"]'); const cwin=getCenter(winIcon); await moveCursorTo(cwin.x,cwin.y,500); await moveCursorTo(tgtPage.left+target.x+70, tgtPage.top+target.y-56, 800); const win=makeWindow(); autoLayer.appendChild(win); setTranslateOnly(win,target.x+70,target.y-56);
    // run button (preview)
    const runBtn=document.querySelector('#demoControls .icon-btn[title="Run"]'); const crun=getCenter(runBtn); await moveCursorTo(crun.x,crun.y,600);
    running.auto=true; startAnim();
  }
  if(demoPlay){ demoPlay.addEventListener('click', ()=>{ clearDemo(); runDemo(); }); }
  if(demoStop){ demoStop.addEventListener('click', ()=>stopMode('auto')); }
})();
</script>
</body>
</html>
        